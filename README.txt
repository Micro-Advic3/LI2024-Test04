# Generated by Django on 2025-11-27
from django.db import migrations
import os


def setup_oidc_provider(apps, schema_editor):
    Site = apps.get_model('sites', 'Site')
    SocialApp = apps.get_model('socialaccount', 'SocialApp')
    
    # Update Site
    site, created = Site.objects.get_or_create(id=1)
    site.domain = 'portal.qdi.dev.echonet'
    site.name = 'QDI Portal'
    site.save()
    print(f"✅ Site updated: {site.domain}")
    
    # Create or update OIDC SocialApp
    social_app, created = SocialApp.objects.update_or_create(
        provider='openid_connect',
        provider_id='bnpp-oidc',
        defaults={
            'name': 'BNPP OIDC',
            'client_id': '000399dfc-2cff-190e-b486-8eb30af30000',
            'secret': os.getenv('OIDC_CLIENT_SECRET', 'temp-secret'),
            'settings': {
                'server_url': 'https://ssoforms.dev.echonet/affwebservices/CASSO/oidc/OMPCIA_portal'
            }
        }
    )
    
    # Add site to social app
    if not social_app.sites.filter(id=site.id).exists():
        social_app.sites.add(site)
    
    print(f"✅ OIDC Provider: {social_app.name} (provider_id: {social_app.provider_id})")


def remove_oidc_provider(apps, schema_editor):
    SocialApp = apps.get_model('socialaccount', 'SocialApp')
    SocialApp.objects.filter(provider_id='bnpp-oidc').delete()


class Migration(migrations.Migration):

    dependencies = [
        ('accounts', '0002_alter_user_managers_alter_user_is_active_and_more'),
        ('sites', '0002_alter_domain_unique'),
        ('socialaccount', '0006_alter_socialaccount_extra_data'),
    ]

    operations = [
        migrations.RunPython(setup_oidc_provider, remove_oidc_provider),
    ]
